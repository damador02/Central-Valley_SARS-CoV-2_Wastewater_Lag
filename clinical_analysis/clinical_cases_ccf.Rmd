---
title: "clinical_cases"
author: "De'Liz Amador"
date: "2025-07-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(zoo)
library(ggplot2)
library(tidyverse)
library(forecast)
library(tidyr)
library(pracma)
```

```{r echo=T, warning=FALSE, message=FALSE}
trim_fun = function(x){
  x = x[!is.na(x)]   # remove NA
  if(length(x) <= 2){
    return(NA)
  }else{
      x1 = sort(x)
      x1 = x1[2:(length(x1)-1)] # Remove max values and min values
      return(mean(x1))
  }
}

# replace 0 (below LOD or ND) by min/deno
replace_min = function(x){
  deno = 4
  x[x == 0] = min(x[x>0],na.rm=T)/deno
  return(x)
}
```

```{r}

cases <- read.csv("covid19cases_test.csv")  # Read the dataset
#unique(cases$area)

#counties of interest (coi)       
coi = c("San Francisco","San Mateo","Santa Clara", "Merced", "Stanislaus")

case_data <- cases %>%
  filter(area %in% coi) %>%
  mutate(date = as.Date(date, format="%Y-%m-%d")) 


case_data <- case_data %>%
  filter(date >= as.Date('2021-10-20') & date <= as.Date('2023-10-31'))
  #filter(date <= as.Date('2021-12-31'))

```

Smoothing Using 7 -day Moving Average
```{r}
var = "cases"

# Calculate the trimmed average of the data change with for more smoothing
clinical <- case_data %>% 
  group_by(area) %>%
  select(all_of(c("date","area", var)))%>%   # Select variables of interest
    rename("cas" = var) %>%
    mutate(cas = ifelse(cas %in% c(NA,NaN,Inf,-Inf),NA,cas),
           cas = replace_min(cas), # replace 0 (below LOD or ND) by min/2 
           cas_7 = rollapply(cas,width=7, trim_fun, align="center", fill=NA) #7 day moving average
           )

# Verify the data before interpolation
#df_lengths <- clinical %>% group_by(area) %>% summarize(n = n())
#df_lengths

colnames(clinical)[2] <- "County"

new_clinical <- clinical[, c("date", "County", "cas_7")] %>% 
  filter(date >= as.Date('2021-10-23') & date <= as.Date('2023-10-28')) %>%
  pivot_wider(names_from = County, values_from = "cas_7")


```

```{r}
p1 <- ggplot(clinical, aes(x = date, y = cas_7, color = County)) + geom_line() + 
  labs(x = "Date", y = "7-day Moving Average", title = "COVID-19 Cases by County")

p1
```

Creating a dataframe of averaged county cases between the BA and CV
```{r}
CV_county <- coi[4:5]
CV_avg <- case_data %>%
  filter(area %in% CV_county) %>%
  group_by(date) %>%
  summarize(cases = mean(cases, na.rm = TRUE), .groups = "drop") %>%
  mutate(area = "Central Valley Average")

BA_county <- coi[1:3]
BA_avg <- case_data %>%
  filter(area %in% BA_county) %>%
  group_by(date) %>%
  summarize(cases = mean(cases, na.rm = TRUE), .groups = "drop") %>%
  mutate(area = "Bay Area Average")

county_avg <- bind_rows(CV_avg, BA_avg)
colnames(county_avg)[3] <- "County"

county_avg <- county_avg %>% 
  group_by(County) %>%
  select(all_of(c("date","County", var)))%>%   # Select variables of interest
    rename("cas" = var) %>%
    mutate(cas = ifelse(cas %in% c(NA,NaN,Inf,-Inf),NA,cas),
           cas = replace_min(cas), # replace 0 (below LOD or ND) by min/2 
           cas_7 = rollapply(cas,width=7, trim_fun, align="center", fill=NA) #7 day moving average
           )

county_avg$cas_7 <- round(county_avg$cas_7, digits = 1)

new_county_avg <- county_avg[, c("date", "County", "cas_7")] %>% 
  filter(date >= as.Date('2021-10-23') & date <= as.Date('2023-10-28')) %>%
  pivot_wider(names_from = County, values_from = "cas_7")
```


Cross-Correlation function for case data
```{r}
# Compute Cross-Correlation Function (CCF)

#Wave 1: 2021-10-23 to 2022-03-31 (M), 3/12 (SF), 3/18 (SM), 3/16 (SC), 3/28 (S) --> avg: ~3/21
#Wave 2: 2022-03-22 to 2022-10-24 (M), 10/18 (SF), 10/23 (SM), 10/17 (SC), 10/7 (S) --> avg: ~10/18
#Wave 3: 2022-10-19 to 2023-06-30
#Wave 4: 2023-07-01 to 2023-10-28

#filtering data set in waves
#ccf_clinical <- new_clinical %>%
 # filter(date <= as.Date('2022-03-21'))
  #filter(date >= as.Date('2022-10-19') & date <= as.Date('2023-06-30'))

ccf_result <- ccf(new_county_avg$`Central Valley Average`, new_county_avg$`Bay Area Average` , lag.max = 20, plot = FALSE) #new_clinical$Stanislaus

# Convert to a data frame for ggplot
ccf_df <- data.frame(
  Lag = ccf_result$lag,
  Correlation = ccf_result$acf
)

CV_county = "Central Valley Average"
BA_county = "Bay Area Average"

# Find optimal lag
opt_lag = ccf_df$Lag[which.max(ccf_df$Correlation)]
# Plot the CCF using ggplot2

ggplot(ccf_df, aes(x = Lag, y = Correlation)) +
  
  geom_segment(aes(xend = Lag, yend = 0), color = "blue") +  # Vertical lines
  
  geom_point(size = 1, color = "blue") +
  
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  
  geom_vline(xintercept = opt_lag, linetype = "dashed", color = "red") +
  
  labs(title = str_c("CCF Between ", CV_county," and ", BA_county),
       
       x = "Lag (Days)", y = "Cross-Correlation") +
  
  theme_minimal()

ggsave(filename = str_c(CV_county, "_", BA_county, ".tiff"), device = "tiff",
                          path = "ccf_cases",
                          width = 11, height = 9.7,units = "cm", dpi = 600)
```

```{r}
library(rlang) # for sym function

# Function to find peak values
##clinical --> individual counties
##county_avg --> averaged CV vs BA values
find_peaks <- function(clinical, county_column = "County", date_column = "date", value_column = "cas_7", window_size = 10) {
  clinical %>%
    group_by_at(county_column) %>%
    mutate(is_peak = (get(value_column) == rollapply(get(value_column), width = window_size, FUN = max, 
                                                     align = "center", fill = NA, partial = TRUE))) %>%
    filter(is_peak) %>%
    select(!!sym(county_column), !!sym(date_column), !!sym(value_column)) %>%
    distinct(!!sym(county_column), !!sym(date_column), .keep_all = TRUE) %>% #ensure each date is once per county
    arrange(!!sym(county_column), !!sym(date_column)) %>%
    ungroup()
}

# Function to count the number of peaks for a given window size
count_peaks <- function(clinical, window_size) {
  peaks <- find_peaks(clinical, county_column = "County", date_column = "date", value_column = "cas_7", window_size = window_size)
  nrow(peaks)
}

# Initialize variables
target_peaks = 35 #HARDCODED; Total number of rows in table (counted the number of waves between both cities)
best_window_size = NULL
closest_peak_count = Inf

# Try different window sizes
for (window_size in seq(5, 200, by = 1)) {
  peak_count = count_peaks(clinical, window_size)
  # cat("Window Size:", window_size, "- Number of Peaks:", peak_count, "\n")
  
  if (abs(peak_count - target_peaks) < closest_peak_count) {
    closest_peak_count = abs(peak_count - target_peaks)
    best_window_size = window_size
  }
}
# cat("Best Window Size:", best_window_size, "\n")

# Use the function on saved data
peak_table <- find_peaks(clinical, county_column = "County", date_column = "date", value_column = "cas_7", window_size = best_window_size)
colnames(peak_table)[3] <- "Cases"


#peak_table = peak_table %>%  filter(!row_number() %in% c(1,7 )) #, 8, 11))

```

Plotting Peaks for Individual county
```{r}
p2 <- p1 +
  geom_point(data = peak_table, aes(x = date, y = Cases, color = County),
             size = 2.5, shape = 19)

p2
```

Plotting Peaks for Averages County Cases
```{r}
p3 <- ggplot(county_avg, aes(x = date, y = cas_7, color = County)) + geom_line() + 
  labs(x = "Date", y = "7-day Moving Average", title = "Averaged COVID-19 Cases")

#p3

p4 <- p3 +
  geom_point(data = peak_table, aes(x = date, y = Cases, color = County),
             size = 2.5, shape = 19)
p4

```

For Individual Counties
```{r}
 pt <- peak_table %>% 
  group_by(County)%>%
  distinct(Cases, .keep_all = TRUE) %>% #only keeping date of when [peak] first occurred
  ungroup()

pt = pt %>%  filter(!row_number() %in% c(4,5,10,23 )) #, 8, 11))

peak_date <- pt %>%
  select('date', 'County') %>%
  pivot_wider(names_from = County, values_from = "date") #%>%
  #ungroup()

mer <- as.data.frame(peak_date$Merced)
colnames(mer)[1] <- "Merced"

stan <- as.data.frame(peak_date$Stanislaus)
colnames(stan)[1] <- "Stanislaus"

SF <- as.data.frame(peak_date$'San Francisco')
colnames(SF)[1] <- "San Francisco"

SC <- as.data.frame(peak_date$'Santa Clara')
colnames(SC)[1] <- "Santa Clara"

SM <- as.data.frame(peak_date$'San Mateo')
colnames(SM)[1] <- "San Mateo"

CV <- cbind(mer,stan)
BA_1 <- cbind(SF, SC)
BA <- cbind(BA_1, SM)

new_pd <- merge(data.frame(CV, row.names = NULL), data.frame(BA, row.names = NULL),
                    by = 0, all = TRUE)[-1]
new_pd$Peaks <- 1:nrow(new_pd) #counting the number of peaks there are
new_pd <- new_pd[, c(6, 3, 4, 5, 1,2)] #rearranging column order

colnames(new_pd)[2] <- "San Francisco"
colnames(new_pd)[3] <- "Santa Clara"
colnames(new_pd)[4] <- "San Mateo"
```

For Averaged Cases
```{r}
 pt <- peak_table %>% 
  group_by(County)%>%
  distinct(Cases, .keep_all = TRUE) %>% #only keeping date of when [peak] first occurred
  ungroup()

cen_cal <- pt %>%
  filter(County == "Central Valley Average") %>%
  select(date)
colnames(cen_cal)[1] <- "Central Valley Average"

bay <- pt %>%
  filter(County == "Bay Area Average") %>%
  select(date)
colnames(bay)[1] <- "Bay Area Average"

combo <- cbind(cen_cal, bay)
combo$Peaks <- 1:nrow(combo)
combo <- combo[, c(3,1,2)]

```


Plotting Peaks for Individual Counties
```{r}
p2 <- p1 +
  geom_point(data = pt, aes(x = date, y = Cases, color = County),
             size = 2.5, shape = 19) +
  theme(legend.position = c(0.8,0.75))

ggsave(filename = str_c("Clinical_cases_peaks.tiff"), device = "tiff",
                          path = "ccf_cases",
                          width = 11, height = 9.7,units = "cm", dpi = 600)

p2
```

Plotting Peaks for Averaged Cases
```{r}
p4 <- p3 +
  geom_point(data = pt, aes(x = date, y = Cases, color = County),
             size = 2.5, shape = 19) +
  theme(legend.position = c(0.75,0.8))

ggsave(filename = str_c("avg_cases_peaks.tiff"), device = "tiff",
                          path = "ccf_cases",
                          width = 11, height = 9.7,units = "cm", dpi = 600)

p4
```


```{r}
library(gt)
peaks_table <- gt(new_pd) %>% #creating table ##new_pd --> indv. counties
    cols_align(
    align = "center",
    columns = c(Peaks, "San Francisco", "Santa Clara", "San Mateo", Merced, Stanislaus) #"Central Valley Average", "Bay Area Average" 
    ) %>%
    tab_style(
      style = list(
        cell_fill("#ECECEC") # fill in color for column
      ),
      locations = cells_body(columns = c("San Francisco", "San Mateo", Stanislaus)) # column with color fill (center column) ##Central Valley Average
    ) %>%
    tab_style(
      style = cell_borders(sides = c("all"), #creating borders for each cell
                           color = "#000000", style = "solid", weight = px(1)),
      locations = cells_body(
        columns = c(Peaks, "San Francisco", "Santa Clara", "San Mateo", Merced, Stanislaus) # creating column/row borders for all columns
      )
    ) %>%
    tab_style(
      style = cell_text(align = "center"), # center aligning columns names
      locations = cells_column_labels(columns = c(Peaks, "San Francisco", "Santa Clara", "San Mateo", Merced, Stanislaus))
    ) %>%
    tab_style(
      style = list(cell_text(color = "#000000")), # applying black font to all columns
      locations = cells_body(columns = c(Peaks, "San Francisco", "Santa Clara", "San Mateo", Merced, Stanislaus))
    ) %>%
    tab_header(title = md("Peaks for County COVID-19 Cases")) #creating table header
  
  gtsave(data = peaks_table, filename = str_c( "ccf_cases_peakstable.png"),
         path = "ccf_cases") #, width = 8.3, units = "cm", res = 600 )
  #NOTE: would need to convert to TIFF externally
  
  
peaks_table

```

Reading in file with combined lags
```{r}
lag_table <- read.csv("case_lag_table.csv")
colnames(lag_table)[1] <- "Central Valley County"
colnames(lag_table)[2] <- "Bay Area County"
colnames(lag_table)[3] <- "Lag (days)"

```

```{r}
library(gt)
lags <- gt(lag_table) %>% #creating table
    cols_align(
    align = "center",
    columns = c("Central Valley County", "Bay Area County", "Lag (days)")
    ) %>%
    tab_style(
      style = list(
        cell_fill("#ECECEC") # fill in color for column
      ),
      locations = cells_body(columns = "Bay Area County") # column with color fill (center column)
    ) %>%
    tab_style(
      style = cell_borders(sides = c("all"), #creating borders for each cell
                           color = "#000000", style = "solid", weight = px(1)),
      locations = cells_body(
        columns = c("Central Valley County", "Bay Area County", "Lag (days)") # creating column/row borders for all columns
      )
    ) %>%
    tab_style(
      style = cell_text(align = "center"), # center aligning columns names
      locations = cells_column_labels(columns = c("Central Valley County", "Bay Area County", "Lag (days)"))
    ) %>%
    tab_style(
      style = list(cell_text(color = "#000000")), # applying black font to all columns
      locations = cells_body(columns = c("Central Valley County", "Bay Area County", "Lag (days)"))
    ) %>%
    tab_header(title = md("**Table 1sd.** CCF Lag for County COVID-19 Cases")) #creating table header
  
  gtsave(data = lags, filename = str_c( "ccf_cases_lag_table.png"),
         path = "ccf_cases") #, width = 8.3, units = "cm", res = 600 )
  #NOTE: would need to convert to TIFF externally
  
  
lags
```

